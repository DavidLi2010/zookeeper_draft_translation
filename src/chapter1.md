#第1章 概述

在过去，每个应用程序都是一个单独的程序，运行在只有一个CPU的单独的计算机上。今天，一切都变了。在大数据和云计算的世界，应用程序由许多独立程序组成，运行在不断变化的计算机的集合上。

与编写一个运行在单独计算机上的单独程序相比，协调这些独立程序的行为困难的多。开发者很容易陷入协调的逻辑中，因而缺少时间正确地编写应用程序的逻辑——或者反过来，在协调的逻辑上花费的时间太少，简单地编写一个粗糙的主控协调器，它是脆弱的，变成不可靠的单点故障。

ZooKeeper被设计成一个健壮的服务，使得应用程序的开发者能够把精力主要集中在他们的应用程序的逻辑上，而不是协调上。它公开了一套简单的API——灵感来自于文件系统的API——使得开发者能够实现通用的协调任务，例如选举主控服务器，管理组成员，以及管理元数据。ZooKeeper是一个应用程序库，有两套主要的API实现——Java和C——以及一个用Java实现的运行在专用服务器组上的服务组件。使用一组服务器使得ZooKeeper能够容错和扩展吞吐量。

在设计使用ZooKeeper的应用程序时，理想的做法是将应用程序数据和控制或协调数据分离。例如，Web邮件服务的用户对他们邮箱的内容感兴趣，但是不会对服务器如何处理对一个特定邮箱的请求感兴趣。邮箱内容是应用程序数据，而邮箱到特定邮件服务器的映射是协调数据（或元数据）的一部分。ZooKeeper总体管理后者。

##ZooKeeper的任务

试图解释ZooKeeper做什么就像试图解释螺丝刀能做什么一样。基本上，螺丝刀能够拧螺丝，但是这并不能真正说明这件工具的能力。我们用它组装家具和电子设备，在某些情况下可以将画挂到墙上。通过给出类似的例子，我们可以明白能够做什么，但是当然这不是全部。

关于类似ZooKeeper的系统能够做什么的争论沿用同样的方式：它使分布式系统能够实现协调任务。协调任务是涉及多个进程的任务。这样的任务可以是出于协作或是管理竞争的目的。协作意味着多个进程需要共同做某件事情，一些进程的活动使得另一些进程进行下去。例如，在典型的master-worker架构中，worker通知master它可以工作了。因此master分配任务给worker。竞争与此不同：它指的是两个进程不能同时进行的情况，因此其中一个进程必须等待另一个。同样以master-worker为例，我们实际需要一个唯一的master，但是有多个进程试图成为master，因此这些进程需要实现互斥。实际上，我们可以把获取master身份的动作看作获取锁的动作：得到代表master身份的锁的进程使用master角色。

如果你有多线程编程的经验，你会发现有许多相似的问题。事实上，许多进程运行在同一台计算机上或者横跨多台计算机在概念上没有不同。在多线程的上下文中有用的同步原语在分布式系统的上下文中同样有用。然而，最重要的差异源于这样的事实————在典型的share-nothing架构中，不同的计算机之间除了网络不共享其它任何东西。尽管有许多种消息传递算法用于实现同步原语，依靠通过一些特殊的顺序属性提供共享存储的组件通常更容易，ZooKeeper正是如此。

协调不只有像leader选举或锁这样的同步原语形式。配置元数据经常作为一个进程传达其它进程应该做什么的一种方式。例如，在master-worker系统中，worker需要知道已经分配给他们的任务。即使master崩溃了，这个信息也必须是可获得的。

让我们看一些使用ZooKeeper的例子，一遍更好的了解它的适用场景：

+ Apache HBase
    HBase通常用于Hadoop的数据存储。在HBase中，ZooKeeper用于选举集群的master，保持对可用服务器的跟踪，保持集群元数据。
+ Apache Kafka
    Kafka是一个消息订阅-推送系统。它使用ZooKeeper检测故障，实现主题发现，维护主题的生产和消费状态。
+ Apache Solr
    Solr是一个企业搜索平台。它的分布式形式称为SolrCloud，使用ZooKeeper存储集群的元数据并协调对元数据的更新。
+ Yahoo！Fetching Service
    作为网络爬虫的实现的一部分，Fetching Service在确信遵守了写在robots.txt中的web服务器政策的情况下，通过缓存内容实现高效的抓取网页。这个服务使用ZooKeeper来选举master，检测故障，存储元数据。
+ Facebook Messages
    这是一个集成通信通道————电子邮件、短消息、Facebook Chat和已有的Facebook收件箱————的Facebook应用程序。它使用ZooKeeper作为控制器来实现分片和故障恢复以及服务发现。
	
除此之外还有许多例子，这里只是一部分。让我们在更抽象的层次展开讨论。当使用ZooKeeper编程的时候，开发者把他们的应用程序设计成一组连接到ZooKeeper服务器的客户端的集合，并且在应用程序上通过ZooKeeper客户端API调用操作。ZooKeeper API提供如下能力：

+ 强一致性，有序，以及持久化的保证
+ 实现典型的同步原语的能力
+ 以更简单的方式处理许多方面的并发，并发在真实的分布式系统中往往导致不正确地行为

然而，ZooKeeper不是魔法；它不能解决所有的问题。理解ZooKeeper能够做什么，了解它难以处理的方面，这是很重要的。本书的目标之一是讨论处理这些问题的方法。我们包含了读者所需的基本材料，使其能够理解对开发者而言Zookeeper真正能做的事情。另外我们讨论了在使用ZooKeeper实现应用程序时遇到的一些问题，对刚接触ZooKeeper的开发者有所帮助。

##ZooKeeper名字的来源

ZooKeeper是在Yahoo！Research开发的。我们先在ZooKeeper上工作了一段时间，然后把它推广给其它组，因此我们需要一个名字。此时开发组已经在跟Hadoop团队合作，并且已经启动了多个用动物命名的项目，Apache Pig是其中最著名的。在讨论各种可能的名字时，庆祝一个开发组成员提出应该避免再使用动物的名称，因为经理会以为听起来我们住在动物园里。灵感由此而来：分布式系统是一个动物园。它是混乱、难以管理的，而动物园管理员就是那个使其保持控制的人。

本书封面上的猫也是合适的，因为在Yahoo！Research的一篇关于ZooKeeper的早期文章中曾提到分布式进程管理就像把猫集中起来养。不管怎样，动物园管理员比养猫人听起来要好吧。

##没有ZooKeeper的世界如何存活

ZooKeeper使得一类全新的应用程序被开发出来？看起来并非如此。相反，ZooKeeper简化了开发过程，使其更敏捷，使实现更健壮。

以前的系统通过实现类似分布式锁管理的组件或者使用分布式数据库来协调。事实上，ZooKeeper从之前的系统上借用了大量的概念。然而，它并没有公开一套锁的接口或是一套通用的数据存储接口。ZooKeeper专门设计用来协调任务。同时，它并未试图对开发者强加一组特别的同步原语，能够非常灵活实现功能。

不使用ZooKeeper当然也能构建分布式系统。然而，ZooKeeper使得开发者能够把精力更多的集中在应用程序的逻辑上，而不是花在难以理解的分布式系统的概念上。没有ZooKeeper的分布式系统的编程是可能的，但是更加困难。

##ZooKeeper不做什么

全体ZooKeeper服务器管理与协调相关的关键应用程序数据。ZooKeeper不是用于大数据量存储的。对于大数据量存储，有大量的可选方案，比如数据库和分布式文件系统。当设计一个使用ZooKeeper的应用程序时，理想的方式是将应用程序数据与控制或协调数据分离。它们通常有不同的需求，例如考虑一致性和持久性。

ZooKeeper实现了一组核心操作，从而能够实现对许多分布式应用程序都通用的任务。你知道有多少应用程序有一个master或者需要跟踪哪个进程有响应？然而，ZooKeeper不会实现你的那些任务。它不会为应用程序选举master或跟踪活着的进程。相反，它提供了实现这些任务的工具。由开发者决定实现哪些协调任务。

##Apache项目

